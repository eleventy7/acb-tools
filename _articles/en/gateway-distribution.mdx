---
category: 'article'
cover: './cover.jpg'
title: 'Gateway Distribution'
subtitle: 'An approach to improving performance in Aeron Cluster with large amounts of connected clients'
description: 'Retaining high performance in an Aeron Cluster when dealing with large amounts of clients'
date: '2020-11-07'
tags: ['Distributed Systems', 'Aeron']
published: true
state: draft
updated: '2020-11-08'
importance: medium
series: part of the building a venue series
seriesurl: ../../building-a-venue
review: continuous
---

import MdxWarningAside from '../../components/MdxWarningAside';

<div class="bg-shaunnew-400 p-4 mb-4 rounded-md dark:text-black">
  <p class="font-bold">Summary</p>
  <p>Individual users often require views customized to their permissions. Shifting the logic used to customize messages from the cluster to a gateway can improve throughput, at the cost of reduced fairness and increased static data replication.</p>
  <p class="italic">Valid scenarios:</p>
  <p><ul>
  <li>Systems which require a high degree of customization. Some systems do not need any customization.</li>
  <li>Anytime absolute fairness is not a legal or regulatory requirement.</li>
    </ul></p>
</div>

In a typical trading system, the UI of different users will often need to see different views on the same underlying data. Using an example of a broker dealer platform, a dealer view of the negotiation will likely differ greatly from the view of a trader taking part in the same negotiation. This customization of messages can become costly as the number of connected clients increases into the hundreds.

Information leakage and security concerns mean that every message on the wire to the client must hold the exact data allowed to be visible by that client. What approaches do we have to improve this?

## Approach 1: Have the cluster customize the messages

This approach is the simplest but will become a bottleneck as user numbers and/or message complexity grow. Construct all required customized messages for the UI to consume inside the cluster during a duty cycle. Each message is then sent to the correct gateway which in turn will send it on to the connected client. In some systems with many users logged in, this can result in customization of thousands of individual messages. While Aeron Cluster is producing these custom messages, it cannot consume the next inbound message, and as a result, cluster throughput falls.

<div align="center">
<svg width="80%" height="auto" viewBox="0 0 750 465" fill="none" xmlns="http://www.w3.org/2000/svg">
<rect x="284" y="108" width="164" height="96" rx="4" fill="#5AC8FA"/>
<text fill="black" xml:space="preserve" font-family="-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen-Sans, Ubuntu, Cantarell, sans-serif" font-size="21" letter-spacing="0px"><tspan x="356.218" y="145.472">UI&#10;</tspan><tspan x="317.273" y="170.472">Gateway 1</tspan></text>
<rect x="284" y="246" width="164" height="96" rx="4" fill="#5AC8FA"/>
<text fill="black" xml:space="preserve" font-family="-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen-Sans, Ubuntu, Cantarell, sans-serif" font-size="21" letter-spacing="0px"><tspan x="356.218" y="283.472">UI&#10;</tspan><tspan x="317.273" y="308.472">Gateway 2</tspan></text>
<rect y="176" width="164" height="96" rx="4" fill="#5AC8FA"/>
<text fill="black" xml:space="preserve" font-family="-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen-Sans, Ubuntu, Cantarell, sans-serif" font-size="21" letter-spacing="0px"><tspan x="48.6235" y="226.472">Cluster</tspan></text>
<rect x="586" width="164" height="86" rx="4" fill="#5AC8FA"/>
<text fill="black" xml:space="preserve" font-family="-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen-Sans, Ubuntu, Cantarell, sans-serif" font-size="21" letter-spacing="0px"><tspan x="602.393" y="37.472">User Interface&#10;</tspan><tspan x="653.745" y="62.472">1.1</tspan></text>
<rect x="585" y="108" width="164" height="96" rx="4" fill="#5AC8FA"/>
<text fill="black" xml:space="preserve" font-family="-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen-Sans, Ubuntu, Cantarell, sans-serif" font-size="21" letter-spacing="0px"><tspan x="601.393" y="150.472">User Interface&#10;</tspan><tspan x="652.745" y="175.472">1.2</tspan></text>
<rect x="585" y="246" width="164" height="96" rx="4" fill="#5AC8FA"/>
<text fill="black" xml:space="preserve" font-family="-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen-Sans, Ubuntu, Cantarell, sans-serif" font-size="21" letter-spacing="0px"><tspan x="600.893" y="288.472">User Interface&#10;</tspan><tspan x="652.245" y="313.472">2.1</tspan></text>
<rect x="585" y="366" width="164" height="96" rx="4" fill="#5AC8FA"/>
<text fill="black" xml:space="preserve" font-family="-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen-Sans, Ubuntu, Cantarell, sans-serif" font-size="21" letter-spacing="0px"><tspan x="600.893" y="408.472">User Interface&#10;</tspan><tspan x="652.245" y="433.472">2.2</tspan></text>
<path d="M284.5 294.5L276.075 279.367L267.182 294.23L284.5 294.5ZM165 223L173.425 238.133L182.318 223.27L165 223ZM166.364 225.564L167.651 226.334L169.191 223.76L167.904 222.99L166.364 225.564ZM172.172 225.543L170.885 224.773L169.344 227.347L170.632 228.118L172.172 225.543ZM174.899 230.671L176.187 231.441L177.727 228.867L176.44 228.097L174.899 230.671ZM180.708 230.65L179.42 229.88L177.88 232.455L179.167 233.225L180.708 230.65ZM183.435 235.778L184.722 236.548L186.263 233.974L184.976 233.204L183.435 235.778ZM189.243 235.757L187.956 234.987L186.416 237.562L187.703 238.332L189.243 235.757ZM191.971 240.885L193.258 241.656L194.798 239.081L193.511 238.311L191.971 240.885ZM197.779 240.865L196.492 240.094L194.952 242.669L196.239 243.439L197.779 240.865ZM200.507 245.993L201.794 246.763L203.334 244.188L202.047 243.418L200.507 245.993ZM206.315 245.972L205.028 245.202L203.487 247.776L204.774 248.546L206.315 245.972ZM209.042 251.1L210.33 251.87L211.87 249.295L210.583 248.525L209.042 251.1ZM214.851 251.079L213.563 250.309L212.023 252.883L213.31 253.653L214.851 251.079ZM217.578 256.207L218.865 256.977L220.406 254.403L219.118 253.632L217.578 256.207ZM223.386 256.186L222.099 255.416L220.559 257.99L221.846 258.76L223.386 256.186ZM226.114 261.314L227.401 262.084L228.941 259.51L227.654 258.74L226.114 261.314ZM231.922 261.293L230.635 260.523L229.094 263.097L230.382 263.868L231.922 261.293ZM234.649 266.421L235.937 267.191L237.477 264.617L236.19 263.847L234.649 266.421ZM240.458 266.4L239.17 265.63L237.63 268.205L238.917 268.975L240.458 266.4ZM243.185 271.528L244.472 272.298L246.013 269.724L244.726 268.954L243.185 271.528ZM248.993 271.507L247.706 270.737L246.166 273.312L247.453 274.082L248.993 271.507ZM251.721 276.635L253.008 277.406L254.548 274.831L253.261 274.061L251.721 276.635ZM257.529 276.615L256.242 275.844L254.702 278.419L255.989 279.189L257.529 276.615ZM260.257 281.743L261.544 282.513L263.084 279.938L261.797 279.168L260.257 281.743ZM266.065 281.722L264.778 280.952L263.237 283.526L264.524 284.296L266.065 281.722ZM268.792 286.85L270.08 287.62L271.62 285.045L270.333 284.275L268.792 286.85ZM274.601 286.829L273.313 286.059L271.773 288.633L273.06 289.403L274.601 286.829ZM277.328 291.957L278.615 292.727L280.156 290.153L278.868 289.382L277.328 291.957ZM283.136 291.936L281.849 291.166L280.309 293.74L281.596 294.51L283.136 291.936ZM170.632 228.118L174.899 230.671L176.44 228.097L172.172 225.543L170.632 228.118ZM179.167 233.225L183.435 235.778L184.976 233.204L180.708 230.65L179.167 233.225ZM187.703 238.332L191.971 240.885L193.511 238.311L189.243 235.757L187.703 238.332ZM196.239 243.439L200.507 245.993L202.047 243.418L197.779 240.865L196.239 243.439ZM204.774 248.546L209.042 251.1L210.583 248.525L206.315 245.972L204.774 248.546ZM213.31 253.653L217.578 256.207L219.118 253.632L214.851 251.079L213.31 253.653ZM221.846 258.76L226.114 261.314L227.654 258.74L223.386 256.186L221.846 258.76ZM230.382 263.868L234.649 266.421L236.19 263.847L231.922 261.293L230.382 263.868ZM238.917 268.975L243.185 271.528L244.726 268.954L240.458 266.4L238.917 268.975ZM247.453 274.082L251.721 276.635L253.261 274.061L248.993 271.507L247.453 274.082ZM255.989 279.189L260.257 281.743L261.797 279.168L257.529 276.615L255.989 279.189ZM264.524 284.296L268.792 286.85L270.333 284.275L266.065 281.722L264.524 284.296ZM273.06 289.403L277.328 291.957L278.868 289.382L274.601 286.829L273.06 289.403Z" fill="black"/>
<path d="M164.75 222.75L182.068 223.067L173.683 207.911L164.75 222.75ZM167.694 222.836L169.006 222.11L167.554 219.484L166.241 220.211L167.694 222.836ZM170.677 217.757L169.364 218.483L170.816 221.108L172.129 220.382L170.677 217.757ZM176.564 217.928L177.877 217.202L176.424 214.577L175.112 215.303L176.564 217.928ZM179.547 212.85L178.234 213.576L179.687 216.201L180.999 215.475L179.547 212.85ZM185.434 213.021L186.747 212.295L185.295 209.67L183.982 210.396L185.434 213.021ZM188.417 207.942L187.105 208.668L188.557 211.293L189.87 210.567L188.417 207.942ZM194.305 208.113L195.617 207.387L194.165 204.762L192.853 205.488L194.305 208.113ZM197.288 203.035L195.975 203.761L197.428 206.386L198.74 205.66L197.288 203.035ZM203.175 203.206L204.488 202.48L203.035 199.855L201.723 200.581L203.175 203.206ZM206.158 198.127L204.846 198.853L206.298 201.478L207.61 200.752L206.158 198.127ZM212.046 198.299L213.358 197.573L211.906 194.947L210.593 195.674L212.046 198.299ZM215.028 193.22L213.716 193.946L215.168 196.571L216.481 195.845L215.028 193.22ZM220.916 193.391L222.228 192.665L220.776 190.04L219.464 190.766L220.916 193.391ZM223.899 188.312L222.586 189.039L224.039 191.664L225.351 190.938L223.899 188.312ZM229.786 188.484L231.099 187.758L229.647 185.133L228.334 185.859L229.786 188.484ZM232.769 183.405L231.457 184.131L232.909 186.756L234.221 186.03L232.769 183.405ZM238.657 183.576L239.969 182.85L238.517 180.225L237.204 180.951L238.657 183.576ZM241.64 178.498L240.327 179.224L241.779 181.849L243.092 181.123L241.64 178.498ZM247.527 178.669L248.84 177.943L247.387 175.318L246.075 176.044L247.527 178.669ZM250.51 173.59L249.197 174.316L250.65 176.941L251.962 176.215L250.51 173.59ZM256.397 173.762L257.71 173.035L256.258 170.41L254.945 171.137L256.397 173.762ZM259.38 168.683L258.068 169.409L259.52 172.034L260.833 171.308L259.38 168.683ZM265.268 168.854L266.58 168.128L265.128 165.503L263.816 166.229L265.268 168.854ZM268.251 163.775L266.938 164.502L268.39 167.127L269.703 166.401L268.251 163.775ZM274.138 163.947L275.451 163.221L273.998 160.596L272.686 161.322L274.138 163.947ZM277.121 158.868L275.809 159.594L277.261 162.219L278.573 161.493L277.121 158.868ZM283.009 159.039L284.321 158.313L282.869 155.688L281.556 156.414L283.009 159.039ZM172.129 220.382L176.564 217.928L175.112 215.303L170.677 217.757L172.129 220.382ZM180.999 215.475L185.434 213.021L183.982 210.396L179.547 212.85L180.999 215.475ZM189.87 210.567L194.305 208.113L192.853 205.488L188.417 207.942L189.87 210.567ZM198.74 205.66L203.175 203.206L201.723 200.581L197.288 203.035L198.74 205.66ZM207.61 200.752L212.046 198.299L210.593 195.674L206.158 198.127L207.61 200.752ZM216.481 195.845L220.916 193.391L219.464 190.766L215.028 193.22L216.481 195.845ZM225.351 190.938L229.786 188.484L228.334 185.859L223.899 188.312L225.351 190.938ZM234.221 186.03L238.657 183.576L237.204 180.951L232.769 183.405L234.221 186.03ZM243.092 181.123L247.527 178.669L246.075 176.044L241.64 178.498L243.092 181.123ZM251.962 176.215L256.397 173.762L254.945 171.137L250.51 173.59L251.962 176.215ZM260.833 171.308L265.268 168.854L263.816 166.229L259.38 168.683L260.833 171.308ZM269.703 166.401L274.138 163.947L272.686 161.322L268.251 163.775L269.703 166.401ZM278.573 161.493L283.009 159.039L281.556 156.414L277.121 158.868L278.573 161.493Z" fill="black"/>
<path d="M585.625 414.625L579.488 398.428L568.53 411.841L585.625 414.625ZM449 303L455.137 319.197L466.095 305.784L449 303ZM576.12 404.922L460.403 310.38L458.505 312.703L574.222 407.245L576.12 404.922Z" fill="black"/>
<path d="M449.75 150.75L466.677 147.079L455.034 134.255L449.75 150.75ZM585.5 27.5L568.573 31.1712L580.216 43.9948L585.5 27.5ZM460.753 142.786L576.513 37.6852L574.497 35.4641L458.737 140.565L460.753 142.786Z" fill="black"/>
<path d="M449.5 294.5L464.532 303.105L464.468 285.784L449.5 294.5ZM585 294L569.968 285.395L570.032 302.716L585 294ZM463.005 295.95L571.506 295.55L571.495 292.55L462.994 292.95L463.005 295.95Z" fill="black"/>
<path d="M449.5 156.5L464.532 165.105L464.468 147.784L449.5 156.5ZM585 156L569.968 147.395L570.032 164.716L585 156ZM463.005 157.95L571.506 157.55L571.495 154.55L462.994 154.95L463.005 157.95Z" fill="black"/>
<rect x="119" y="240" width="51" height="42" rx="10" fill="#AF52DE"/>
<rect x="565" y="53" width="51" height="42" rx="10" fill="#AF52DE"/>
<rect x="129" y="253" width="51" height="42" rx="10" fill="#2ACC41"/>
<rect x="421" y="169" width="51" height="42" rx="10" fill="#AF52DE"/>
<rect x="431" y="182" width="51" height="42" rx="10" fill="#2ACC41"/>
<rect x="565" y="168" width="51" height="42" rx="10" fill="#2ACC41"/>
<rect x="140" y="266" width="51" height="42" rx="10" fill="#FFCC02"/>
<rect x="565" y="307" width="51" height="42" rx="10" fill="#FFCC02"/>
<rect x="150" y="279" width="51" height="42" rx="10" fill="#FF2E55"/>
<rect x="416" y="328" width="51" height="42" rx="10" fill="#FFCC02"/>
<rect x="426" y="341" width="51" height="42" rx="10" fill="#FF2E55"/>
<rect x="565" y="423" width="51" height="42" rx="10" fill="#FF2E55"/>
</svg>

</div>

Due to the simplicity, it is typical for this approach to be used early in a trading system's development.

## Approach 2: Shift the logic into the gateways

This approach requires a lot more groundwork, typically including a framework for static data distribution. Build the UI to hold key static data within an in-process store to reduce the need to move slowly changing static data over every message.


<MdxWarningAside asideTitle='warning' asideBody='By moving logic to the gateways, you can introduce unfairness. Heavily loaded gateways will delay messages when compared to lightly loaded gateways. To prevent any unfairness, use a single gateway. To add resilience in this scenario, keep a second gateway warm but inactive.'/>

<div align="center" className="mt-8">
<svg width="80%" height="auto" viewBox="0 0 750 465" fill="none" xmlns="http://www.w3.org/2000/svg">
<rect x="284" y="108" width="164" height="96" rx="4" fill="#5AC8FA"/>
<text fill="black" xml:space="preserve" font-family="-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen-Sans, Ubuntu, Cantarell, sans-serif" font-size="21" letter-spacing="0px"><tspan x="356.218" y="145.472">UI&#10;</tspan><tspan x="317.273" y="170.472">Gateway 1</tspan></text>
<rect x="284" y="246" width="164" height="96" rx="4" fill="#5AC8FA"/>
<text fill="black" xml:space="preserve" font-family="-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen-Sans, Ubuntu, Cantarell, sans-serif" font-size="21" letter-spacing="0px"><tspan x="356.218" y="283.472">UI&#10;</tspan><tspan x="317.273" y="308.472">Gateway 2</tspan></text>
<rect y="176" width="164" height="96" rx="4" fill="#5AC8FA"/>
<text fill="black" xml:space="preserve" font-family="-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen-Sans, Ubuntu, Cantarell, sans-serif" font-size="21" letter-spacing="0px"><tspan x="48.6235" y="226.472">Cluster</tspan></text>
<rect x="586" width="164" height="86" rx="4" fill="#5AC8FA"/>
<text fill="black" xml:space="preserve" font-family="-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen-Sans, Ubuntu, Cantarell, sans-serif" font-size="21" letter-spacing="0px"><tspan x="602.393" y="37.472">User Interface&#10;</tspan><tspan x="653.745" y="62.472">1.1</tspan></text>
<rect x="585" y="108" width="164" height="96" rx="4" fill="#5AC8FA"/>
<text fill="black" xml:space="preserve" font-family="-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen-Sans, Ubuntu, Cantarell, sans-serif" font-size="21" letter-spacing="0px"><tspan x="601.393" y="150.472">User Interface&#10;</tspan><tspan x="652.745" y="175.472">1.2</tspan></text>
<rect x="585" y="246" width="164" height="96" rx="4" fill="#5AC8FA"/>
<text fill="black" xml:space="preserve" font-family="-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen-Sans, Ubuntu, Cantarell, sans-serif" font-size="21" letter-spacing="0px"><tspan x="600.893" y="288.472">User Interface&#10;</tspan><tspan x="652.245" y="313.472">2.1</tspan></text>
<rect x="585" y="366" width="164" height="96" rx="4" fill="#5AC8FA"/>
<text fill="black" xml:space="preserve" font-family="-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen-Sans, Ubuntu, Cantarell, sans-serif" font-size="21" letter-spacing="0px"><tspan x="600.893" y="408.472">User Interface&#10;</tspan><tspan x="652.245" y="433.472">2.2</tspan></text>
<path d="M284.5 294.5L276.075 279.367L267.182 294.23L284.5 294.5ZM165 223L173.425 238.133L182.318 223.27L165 223ZM166.364 225.564L167.651 226.334L169.191 223.76L167.904 222.99L166.364 225.564ZM172.172 225.543L170.885 224.773L169.344 227.347L170.632 228.118L172.172 225.543ZM174.899 230.671L176.187 231.441L177.727 228.867L176.44 228.097L174.899 230.671ZM180.708 230.65L179.42 229.88L177.88 232.455L179.167 233.225L180.708 230.65ZM183.435 235.778L184.722 236.548L186.263 233.974L184.976 233.204L183.435 235.778ZM189.243 235.757L187.956 234.987L186.416 237.562L187.703 238.332L189.243 235.757ZM191.971 240.885L193.258 241.656L194.798 239.081L193.511 238.311L191.971 240.885ZM197.779 240.865L196.492 240.094L194.952 242.669L196.239 243.439L197.779 240.865ZM200.507 245.993L201.794 246.763L203.334 244.188L202.047 243.418L200.507 245.993ZM206.315 245.972L205.028 245.202L203.487 247.776L204.774 248.546L206.315 245.972ZM209.042 251.1L210.33 251.87L211.87 249.295L210.583 248.525L209.042 251.1ZM214.851 251.079L213.563 250.309L212.023 252.883L213.31 253.653L214.851 251.079ZM217.578 256.207L218.865 256.977L220.406 254.403L219.118 253.632L217.578 256.207ZM223.386 256.186L222.099 255.416L220.559 257.99L221.846 258.76L223.386 256.186ZM226.114 261.314L227.401 262.084L228.941 259.51L227.654 258.74L226.114 261.314ZM231.922 261.293L230.635 260.523L229.094 263.097L230.382 263.868L231.922 261.293ZM234.649 266.421L235.937 267.191L237.477 264.617L236.19 263.847L234.649 266.421ZM240.458 266.4L239.17 265.63L237.63 268.205L238.917 268.975L240.458 266.4ZM243.185 271.528L244.472 272.298L246.013 269.724L244.726 268.954L243.185 271.528ZM248.993 271.507L247.706 270.737L246.166 273.312L247.453 274.082L248.993 271.507ZM251.721 276.635L253.008 277.406L254.548 274.831L253.261 274.061L251.721 276.635ZM257.529 276.615L256.242 275.844L254.702 278.419L255.989 279.189L257.529 276.615ZM260.257 281.743L261.544 282.513L263.084 279.938L261.797 279.168L260.257 281.743ZM266.065 281.722L264.778 280.952L263.237 283.526L264.524 284.296L266.065 281.722ZM268.792 286.85L270.08 287.62L271.62 285.045L270.333 284.275L268.792 286.85ZM274.601 286.829L273.313 286.059L271.773 288.633L273.06 289.403L274.601 286.829ZM277.328 291.957L278.615 292.727L280.156 290.153L278.868 289.382L277.328 291.957ZM283.136 291.936L281.849 291.166L280.309 293.74L281.596 294.51L283.136 291.936ZM170.632 228.118L174.899 230.671L176.44 228.097L172.172 225.543L170.632 228.118ZM179.167 233.225L183.435 235.778L184.976 233.204L180.708 230.65L179.167 233.225ZM187.703 238.332L191.971 240.885L193.511 238.311L189.243 235.757L187.703 238.332ZM196.239 243.439L200.507 245.993L202.047 243.418L197.779 240.865L196.239 243.439ZM204.774 248.546L209.042 251.1L210.583 248.525L206.315 245.972L204.774 248.546ZM213.31 253.653L217.578 256.207L219.118 253.632L214.851 251.079L213.31 253.653ZM221.846 258.76L226.114 261.314L227.654 258.74L223.386 256.186L221.846 258.76ZM230.382 263.868L234.649 266.421L236.19 263.847L231.922 261.293L230.382 263.868ZM238.917 268.975L243.185 271.528L244.726 268.954L240.458 266.4L238.917 268.975ZM247.453 274.082L251.721 276.635L253.261 274.061L248.993 271.507L247.453 274.082ZM255.989 279.189L260.257 281.743L261.797 279.168L257.529 276.615L255.989 279.189ZM264.524 284.296L268.792 286.85L270.333 284.275L266.065 281.722L264.524 284.296ZM273.06 289.403L277.328 291.957L278.868 289.382L274.601 286.829L273.06 289.403Z" fill="black"/>
<path d="M164.75 222.75L182.068 223.067L173.683 207.911L164.75 222.75ZM167.694 222.836L169.006 222.11L167.554 219.484L166.241 220.211L167.694 222.836ZM170.677 217.757L169.364 218.483L170.816 221.108L172.129 220.382L170.677 217.757ZM176.564 217.928L177.877 217.202L176.424 214.577L175.112 215.303L176.564 217.928ZM179.547 212.85L178.234 213.576L179.687 216.201L180.999 215.475L179.547 212.85ZM185.434 213.021L186.747 212.295L185.295 209.67L183.982 210.396L185.434 213.021ZM188.417 207.942L187.105 208.668L188.557 211.293L189.87 210.567L188.417 207.942ZM194.305 208.113L195.617 207.387L194.165 204.762L192.853 205.488L194.305 208.113ZM197.288 203.035L195.975 203.761L197.428 206.386L198.74 205.66L197.288 203.035ZM203.175 203.206L204.488 202.48L203.035 199.855L201.723 200.581L203.175 203.206ZM206.158 198.127L204.846 198.853L206.298 201.478L207.61 200.752L206.158 198.127ZM212.046 198.299L213.358 197.573L211.906 194.947L210.593 195.674L212.046 198.299ZM215.028 193.22L213.716 193.946L215.168 196.571L216.481 195.845L215.028 193.22ZM220.916 193.391L222.228 192.665L220.776 190.04L219.464 190.766L220.916 193.391ZM223.899 188.312L222.586 189.039L224.039 191.664L225.351 190.938L223.899 188.312ZM229.786 188.484L231.099 187.758L229.647 185.133L228.334 185.859L229.786 188.484ZM232.769 183.405L231.457 184.131L232.909 186.756L234.221 186.03L232.769 183.405ZM238.657 183.576L239.969 182.85L238.517 180.225L237.204 180.951L238.657 183.576ZM241.64 178.498L240.327 179.224L241.779 181.849L243.092 181.123L241.64 178.498ZM247.527 178.669L248.84 177.943L247.387 175.318L246.075 176.044L247.527 178.669ZM250.51 173.59L249.197 174.316L250.65 176.941L251.962 176.215L250.51 173.59ZM256.397 173.762L257.71 173.035L256.258 170.41L254.945 171.137L256.397 173.762ZM259.38 168.683L258.068 169.409L259.52 172.034L260.833 171.308L259.38 168.683ZM265.268 168.854L266.58 168.128L265.128 165.503L263.816 166.229L265.268 168.854ZM268.251 163.775L266.938 164.502L268.39 167.127L269.703 166.401L268.251 163.775ZM274.138 163.947L275.451 163.221L273.998 160.596L272.686 161.322L274.138 163.947ZM277.121 158.868L275.809 159.594L277.261 162.219L278.573 161.493L277.121 158.868ZM283.009 159.039L284.321 158.313L282.869 155.688L281.556 156.414L283.009 159.039ZM172.129 220.382L176.564 217.928L175.112 215.303L170.677 217.757L172.129 220.382ZM180.999 215.475L185.434 213.021L183.982 210.396L179.547 212.85L180.999 215.475ZM189.87 210.567L194.305 208.113L192.853 205.488L188.417 207.942L189.87 210.567ZM198.74 205.66L203.175 203.206L201.723 200.581L197.288 203.035L198.74 205.66ZM207.61 200.752L212.046 198.299L210.593 195.674L206.158 198.127L207.61 200.752ZM216.481 195.845L220.916 193.391L219.464 190.766L215.028 193.22L216.481 195.845ZM225.351 190.938L229.786 188.484L228.334 185.859L223.899 188.312L225.351 190.938ZM234.221 186.03L238.657 183.576L237.204 180.951L232.769 183.405L234.221 186.03ZM243.092 181.123L247.527 178.669L246.075 176.044L241.64 178.498L243.092 181.123ZM251.962 176.215L256.397 173.762L254.945 171.137L250.51 173.59L251.962 176.215ZM260.833 171.308L265.268 168.854L263.816 166.229L259.38 168.683L260.833 171.308ZM269.703 166.401L274.138 163.947L272.686 161.322L268.251 163.775L269.703 166.401ZM278.573 161.493L283.009 159.039L281.556 156.414L277.121 158.868L278.573 161.493Z" fill="black"/>
<path d="M585.625 414.625L579.488 398.428L568.53 411.841L585.625 414.625ZM449 303L455.137 319.197L466.095 305.784L449 303ZM576.12 404.922L460.403 310.38L458.505 312.703L574.222 407.245L576.12 404.922Z" fill="black"/>
<path d="M449.75 150.75L466.677 147.079L455.034 134.255L449.75 150.75ZM585.5 27.5L568.573 31.1712L580.216 43.9948L585.5 27.5ZM460.753 142.786L576.513 37.6852L574.497 35.4641L458.737 140.565L460.753 142.786Z" fill="black"/>
<path d="M449.5 294.5L464.532 303.105L464.468 285.784L449.5 294.5ZM585 294L569.968 285.395L570.032 302.716L585 294ZM463.005 295.95L571.506 295.55L571.495 292.55L462.994 292.95L463.005 295.95Z" fill="black"/>
<path d="M449.5 156.5L464.532 165.105L464.468 147.784L449.5 156.5ZM585 156L569.968 147.395L570.032 164.716L585 156ZM463.005 157.95L571.506 157.55L571.495 154.55L462.994 154.95L463.005 157.95Z" fill="black"/>
<rect x="418" y="177" width="51" height="42" rx="10" fill="#AF52DE"/>
<rect x="565" y="53" width="51" height="42" rx="10" fill="#AF52DE"/>
<rect x="428" y="189" width="51" height="42" rx="10" fill="#2ACC41"/>
<rect x="131" y="246" width="51" height="42" rx="10" fill="#FC826F"/>
<rect x="565" y="168" width="51" height="42" rx="10" fill="#2ACC41"/>
<rect x="412" y="324" width="51" height="42" rx="10" fill="#FFCC02"/>
<rect x="565" y="307" width="51" height="42" rx="10" fill="#FFCC02"/>
<rect x="424" y="338" width="51" height="42" rx="10" fill="#FF2E55"/>
<rect x="565" y="423" width="51" height="42" rx="10" fill="#FF2E55"/>
</svg>

</div>

To shift the distribution logic into the gateways, the cluster broadcasts data for a new state in the state machine. Included with this state change is all the required input data for the customization process.  Each gateway customizes the messages for every user connected to it. It is likely that each gateway will need to reference static data store within the gateway and/or UI.

This approach can introduce invalid data for short periods of time, depending on how you manage your static data. If static data is running via the cluster, there should be no issue; if, however, your cluster has no or limited static data, and static data is instead replicated to the gateways via another route, then the possibility of a race condition exists.

With this in place, the cluster can continue processing inbound messages while gateways are customizing outbound messages. The system can then add additional gateways to achieve scale-out scalability.